{{- include "stress.deploy-job-template.from-job" (list . "stress.deploy-example") -}}
{{- define "stress.deploy-example" -}}
spec:
  {{ if eq .Stress.Scenario "sender" }}
  completions: 2
  parallelism: 2
  {{ end }}
  {{ if eq .Stress.Scenario "receiver" }}
  completions: 2
  parallelism: 2
  {{ end }}
  completionMode: Indexed
  template:
    metadata:
      labels:
        testInstance: "eventhubs-{{ .Release.Name }}-{{ .Release.Revision }}"
        testName: eventhubs-stress-test
        chaos: "true"
    spec:
      nodeSelector:
        sku: 'highMem'
      containers:
        - name: receiver
          image: {{.Stress.imageTag}}
          imagePullPolicy: Always
          command: ['sh', '-c']
          args:
          {{ if eq .Stress.Scenario "sender" }}
            - |
              set -a &&
              source $ENV_FILE &&
              export CONTAINER_NAME=sender &&
              export APPLICATIONINSIGHTS_ROLE_NAME=sender &&
              export AZURE_HTTP_LOG_DETAIL_LEVEL=basic &&
              java -javaagent:BOOT-INF/classes/applicationinsights-agent-3.4.1.jar \
              "org.springframework.boot.loader.JarLauncher" \
              --TEST_CLASS=EventSender
          {{ end }}
          {{ if eq .Stress.Scenario "receiver" }}
            - |
              set -a &&
              source $ENV_FILE &&
              export CONTAINER_NAME=receiver &&
              export APPLICATIONINSIGHTS_ROLE_NAME=receiver &&
              export AZURE_HTTP_LOG_DETAIL_LEVEL=basic &&
              java -javaagent:BOOT-INF/classes/applicationinsights-agent-3.4.1.jar \
              "org.springframework.boot.loader.JarLauncher" \
              --TEST_CLASS=EventProcessor
          {{ end }}
          {{- include "stress-test-addons.container-env" . | nindent 10}}
          resources:
            requests:
              memory: "1G"
              cpu: "1"
            limits:
              memory: "2G"
              cpu: "2"
  {{- end -}}

  {{- define "stress.deploy-job-template.from-job" -}}
  {{- $global := index . 0 -}}
  {{- $jobOverrideDefinition := index . 1 -}}
  # Configmap template that adds the stress test ARM template for mounting
  {{- include "stress-test-addons.deploy-configmap" $global}}
  {{- range (default (list "stress") $global.Values.scenarios)}}
---
  {{$jobCtx := fromYaml (include "stress-test-addons.util.mergeStressContext" (list $global . ))}}
  {{- $jobOverride := fromYaml (include $jobOverrideDefinition $jobCtx) -}}
  {{- $tpl := fromYaml (include "stress-test-addons.deploy-job-template.tpl" $jobCtx) -}}
  {{- toYaml (merge $jobOverride $tpl) -}}
  {{- end}}
  {{- end -}}
